
<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Rent Details</title>
<link rel="stylesheet" href="style.css">
</head><body>
<header><h1>My Rent Details</h1></header>
<div class="container">
  <div class="card" id="profile"></div>

  <div class="card">
    <h3>Change Password</h3>
    <div class="form-grid">
      <input id="oldPwd" type="password" placeholder="Old Password">
      <input id="newPwd" type="password" placeholder="New Password">
      <input id="newPwd2" type="password" placeholder="Confirm New Password">
    </div>
    <div class="center" style="margin-top:10px">
      <button id="btnChange">Update Password</button>
      <a class="link" href="#" onclick="logout();return false;">Logout</a>
    </div>
    <p class="notice" id="msg"></p>
  </div>

  <div class="card">
    <div class="center">
      <button id="btnExportMe">Download My Payment History (CSV)</button>
      <button id="btnWhatsAppMe">Send Reminder to Me</button>
    </div>
  </div>
</div>
<script src="common.js"></script>
<script>
const sess = getSession(); if(!sess || sess.role!=='renter'){ location.href='login.html'; }
const members = loadMembers();
const me = members.find(x => x.userId===sess.userId);
if(!me){ alert('Your record was not found.'); logout(); }

function renderMe(){
  const el = document.getElementById('profile');
  const badge = me.rentStatus==='Paid' ? '<span class="badge paid">Paid</span>' : '<span class="badge due">Due</span>';
  el.innerHTML = `
    <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
      <img class="thumb" src="${me.photo||''}">
      <div>
        <h2 style="margin:0;">${me.renterName} (${me.relationType}: ${me.relationName})</h2>
        <div class="notice">${me.nativeAddress||''}</div>
        <div class="notice">Phone: ${me.phone||''}</div>
      </div>
    </div>
    <div style="margin-top:12px" class="table-wrap">
      <table>
        <thead><tr>
          <th>Family</th><th>Admission</th><th>Vacate</th>
          <th>Rent ₹</th><th>Paid Rent Date</th><th>Status</th>
          <th>Current Bill</th><th>Bill Paid Date</th><th>Bore Bill</th>
        </tr></thead>
        <tbody><tr>
          <td>${me.familyCount||''}</td>
          <td>${me.admissionDate||''}</td>
          <td>${me.vacateDate||''}</td>
          <td>₹${formatINR(me.rentAmount)}</td>
          <td>${me.paidRentDate||''}</td>
          <td>${badge}</td>
          <td>₹${formatINR(me.currentBill)}</td>
          <td>${me.currentBillPaidDate||''}</td>
          <td>₹${formatINR(me.boreBill)}</td>
        </tr></tbody>
      </table>
      <p class="notice">Reminder: Please send rent by due date 6th of every month.</p>
    </div>
  `;
}

document.getElementById('btnChange').addEventListener('click', ()=>{
  const oldPwd = document.getElementById('oldPwd').value;
  const newPwd = document.getElementById('newPwd').value;
  const newPwd2 = document.getElementById('newPwd2').value;
  const msg = document.getElementById('msg');
  if(!oldPwd || !newPwd || !newPwd2){ msg.textContent='Fill all fields'; return; }
  if(oldPwd !== me.password){ msg.textContent='Old password is incorrect'; return; }
  if(newPwd !== newPwd2){ msg.textContent='New passwords do not match'; return; }
  me.password = newPwd;
  saveMembers(members);
  msg.textContent='Password updated successfully';
});

document.getElementById('btnExportMe').addEventListener('click', ()=>{
  const head = ["Renter","Address","Phone","Rent","Paid Rent Date","Status","Current Bill","Bill Paid Date","Bore Bill"];
  const row = [[
    `${me.renterName} (${me.relationType}: ${me.relationName})`,
    (me.nativeAddress||'').replace(/,|\n/g,' '),
    me.phone||'',
    me.rentAmount||'',
    me.paidRentDate||'',
    me.rentStatus||'',
    me.currentBill||'',
    me.currentBillPaidDate||'',
    me.boreBill||''
  ]];
  const csv = [head, ...row].map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `my_rent_${todayISO()}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
});

document.getElementById('btnWhatsAppMe').addEventListener('click', ()=>{
  const msg = `Please send rent by due date 6th of every month. Rent Amount: ₹${me.rentAmount}.`;
  const phone = (me.phone||'').replace(/[^0-9]/g,'');
  const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
  window.open(url,'_blank');
});

renderMe();
</script>
</body></html>
